#!/usr/bin/env ts-node

import 'dotenv/config';
import { whitelist } from '../../src/routes/api/whitelist/whitelist';
import { type WhitelistRequest } from '../../src/routes/api/whitelist/WhitelistRequest';
import { Insertion } from '../../src/lib/server/booking/insertion';

const params = {
	start: {
		lat: 51.5338373,
		lng: 14.5364242
	},
	target: {
		lat: 51.5566873,
		lng: 14.6996425
	},
	startBusStops: [
		{
			lat: 51.505424,
			lng: 14.639178999999999,
			times: [
				'2025-08-06T11:35:00.000Z',
				'2025-08-06T12:35:00.000Z',
				'2025-08-06T13:35:00.000Z',
				'2025-08-06T14:35:00.000Z',
				'2025-08-06T15:35:00.000Z',
				'2025-08-06T16:35:00.000Z',
				'2025-08-06T17:35:00.000Z',
				'2025-08-06T18:35:00.000Z',
				'2025-08-07T03:35:00.000Z',
				'2025-08-07T04:35:00.000Z',
				'2025-08-07T05:35:00.000Z',
				'2025-08-07T06:35:00.000Z',
				'2025-08-07T07:35:00.000Z',
				'2025-08-07T08:35:00.000Z',
				'2025-08-07T09:35:00.000Z',
				'2025-08-07T10:35:00.000Z',
				'2025-08-07T11:35:00.000Z'
			]
		},
		{
			lat: 51.5058,
			lng: 14.642610999999999,
			times: [
				'2025-08-06T11:36:00.000Z',
				'2025-08-06T12:36:00.000Z',
				'2025-08-06T13:36:00.000Z',
				'2025-08-06T14:36:00.000Z',
				'2025-08-06T15:36:00.000Z',
				'2025-08-06T16:36:00.000Z',
				'2025-08-06T17:36:00.000Z',
				'2025-08-06T18:36:00.000Z',
				'2025-08-07T03:36:00.000Z',
				'2025-08-07T04:36:00.000Z',
				'2025-08-07T05:36:00.000Z',
				'2025-08-07T06:36:00.000Z',
				'2025-08-07T07:36:00.000Z',
				'2025-08-07T08:36:00.000Z',
				'2025-08-07T09:36:00.000Z',
				'2025-08-07T10:36:00.000Z',
				'2025-08-07T11:36:00.000Z',
				'2025-08-07T12:36:00.000Z'
			]
		}
	],
	targetBusStops: [
		{
			lat: 51.541595,
			lng: 14.533987,
			times: ['2025-08-06T11:29:00.000Z', '2025-08-07T05:31:00.000Z', '2025-08-07T11:29:00.000Z']
		},
		{
			lat: 51.50438,
			lng: 14.635010999999999,
			times: ['2025-08-07T03:12:00.000Z']
		},
		{
			lat: 51.5058,
			lng: 14.642610999999999,
			times: [
				'2025-08-06T12:06:00.000Z',
				'2025-08-06T13:57:00.000Z',
				'2025-08-06T15:57:00.000Z',
				'2025-08-07T03:57:00.000Z',
				'2025-08-07T05:57:00.000Z',
				'2025-08-07T07:57:00.000Z',
				'2025-08-07T09:57:00.000Z',
				'2025-08-07T12:06:00.000Z'
			]
		},
		{
			lat: 51.50830500000001,
			lng: 14.644146999999998,
			times: [
				'2025-08-06T12:04:00.000Z',
				'2025-08-06T13:04:00.000Z',
				'2025-08-06T14:04:00.000Z',
				'2025-08-06T15:04:00.000Z',
				'2025-08-06T16:04:00.000Z',
				'2025-08-06T17:04:00.000Z',
				'2025-08-07T04:04:00.000Z',
				'2025-08-07T05:04:00.000Z',
				'2025-08-07T06:04:00.000Z',
				'2025-08-07T07:04:00.000Z',
				'2025-08-07T08:04:00.000Z',
				'2025-08-07T09:04:00.000Z',
				'2025-08-07T10:04:00.000Z',
				'2025-08-07T11:04:00.000Z',
				'2025-08-07T12:04:00.000Z',
				'2025-08-07T13:04:00.000Z'
			]
		},
		{
			lat: 51.505444,
			lng: 14.638026999999997,
			times: [
				'2025-08-06T11:40:00.000Z',
				'2025-08-06T12:40:00.000Z',
				'2025-08-06T13:40:00.000Z',
				'2025-08-06T14:40:00.000Z',
				'2025-08-06T15:40:00.000Z',
				'2025-08-06T16:40:00.000Z',
				'2025-08-06T17:40:00.000Z',
				'2025-08-06T18:40:00.000Z',
				'2025-08-06T19:40:00.000Z',
				'2025-08-06T20:40:00.000Z',
				'2025-08-07T02:24:00.000Z',
				'2025-08-07T03:40:00.000Z',
				'2025-08-07T04:40:00.000Z',
				'2025-08-07T05:40:00.000Z',
				'2025-08-07T06:40:00.000Z',
				'2025-08-07T07:40:00.000Z',
				'2025-08-07T08:40:00.000Z',
				'2025-08-07T09:40:00.000Z',
				'2025-08-07T10:40:00.000Z',
				'2025-08-07T11:40:00.000Z',
				'2025-08-07T12:40:00.000Z'
			]
		}
	],
	directTimes: [
		'2025-08-06T10:54:00.000Z',
		'2025-08-06T10:59:00.000Z',
		'2025-08-06T11:04:00.000Z',
		'2025-08-06T11:09:00.000Z',
		'2025-08-06T11:14:00.000Z',
		'2025-08-06T11:19:00.000Z',
		'2025-08-06T11:24:00.000Z',
		'2025-08-06T11:29:00.000Z',
		'2025-08-06T11:34:00.000Z',
		'2025-08-06T11:39:00.000Z',
		'2025-08-06T11:44:00.000Z',
		'2025-08-06T11:49:00.000Z',
		'2025-08-06T11:54:00.000Z',
		'2025-08-06T11:59:00.000Z',
		'2025-08-06T12:04:00.000Z',
		'2025-08-06T12:09:00.000Z',
		'2025-08-06T12:14:00.000Z',
		'2025-08-06T12:19:00.000Z',
		'2025-08-06T12:24:00.000Z',
		'2025-08-06T12:29:00.000Z',
		'2025-08-06T12:34:00.000Z',
		'2025-08-06T12:39:00.000Z',
		'2025-08-06T12:44:00.000Z',
		'2025-08-06T12:49:00.000Z',
		'2025-08-06T12:54:00.000Z',
		'2025-08-06T12:59:00.000Z',
		'2025-08-06T13:04:00.000Z',
		'2025-08-06T13:09:00.000Z',
		'2025-08-06T13:14:00.000Z',
		'2025-08-06T13:19:00.000Z',
		'2025-08-06T13:24:00.000Z',
		'2025-08-06T13:29:00.000Z',
		'2025-08-06T13:34:00.000Z',
		'2025-08-06T13:39:00.000Z',
		'2025-08-06T13:44:00.000Z',
		'2025-08-06T13:49:00.000Z',
		'2025-08-06T13:54:00.000Z',
		'2025-08-06T13:59:00.000Z',
		'2025-08-06T14:04:00.000Z',
		'2025-08-06T14:09:00.000Z',
		'2025-08-06T14:14:00.000Z',
		'2025-08-06T14:19:00.000Z',
		'2025-08-06T14:24:00.000Z',
		'2025-08-06T14:29:00.000Z',
		'2025-08-06T14:34:00.000Z',
		'2025-08-06T14:39:00.000Z',
		'2025-08-06T14:44:00.000Z',
		'2025-08-06T14:49:00.000Z',
		'2025-08-06T14:54:00.000Z',
		'2025-08-06T14:59:00.000Z',
		'2025-08-06T15:04:00.000Z',
		'2025-08-06T15:09:00.000Z',
		'2025-08-06T15:14:00.000Z',
		'2025-08-06T15:19:00.000Z',
		'2025-08-06T15:24:00.000Z',
		'2025-08-06T15:29:00.000Z',
		'2025-08-06T15:34:00.000Z',
		'2025-08-06T15:39:00.000Z',
		'2025-08-06T15:44:00.000Z',
		'2025-08-06T15:49:00.000Z',
		'2025-08-06T15:54:00.000Z',
		'2025-08-06T15:59:00.000Z',
		'2025-08-06T16:04:00.000Z',
		'2025-08-06T16:09:00.000Z',
		'2025-08-06T16:14:00.000Z',
		'2025-08-06T16:19:00.000Z',
		'2025-08-06T16:24:00.000Z',
		'2025-08-06T16:29:00.000Z',
		'2025-08-06T16:34:00.000Z',
		'2025-08-06T16:39:00.000Z',
		'2025-08-06T16:44:00.000Z',
		'2025-08-06T16:49:00.000Z',
		'2025-08-06T16:54:00.000Z',
		'2025-08-06T16:59:00.000Z',
		'2025-08-06T17:04:00.000Z',
		'2025-08-06T17:09:00.000Z',
		'2025-08-06T17:14:00.000Z',
		'2025-08-06T17:19:00.000Z',
		'2025-08-06T17:24:00.000Z',
		'2025-08-06T17:29:00.000Z',
		'2025-08-06T17:34:00.000Z',
		'2025-08-06T17:39:00.000Z',
		'2025-08-06T17:44:00.000Z',
		'2025-08-06T17:49:00.000Z',
		'2025-08-06T17:54:00.000Z',
		'2025-08-06T17:59:00.000Z',
		'2025-08-06T18:04:00.000Z',
		'2025-08-06T18:09:00.000Z',
		'2025-08-06T18:14:00.000Z',
		'2025-08-06T18:19:00.000Z',
		'2025-08-06T18:24:00.000Z',
		'2025-08-06T18:29:00.000Z',
		'2025-08-06T18:34:00.000Z',
		'2025-08-06T18:39:00.000Z',
		'2025-08-06T18:44:00.000Z',
		'2025-08-06T18:49:00.000Z',
		'2025-08-06T18:54:00.000Z',
		'2025-08-06T18:59:00.000Z',
		'2025-08-06T19:04:00.000Z',
		'2025-08-06T19:09:00.000Z',
		'2025-08-06T19:14:00.000Z',
		'2025-08-06T19:19:00.000Z',
		'2025-08-06T19:24:00.000Z',
		'2025-08-06T19:29:00.000Z',
		'2025-08-06T19:34:00.000Z',
		'2025-08-06T19:39:00.000Z',
		'2025-08-06T19:44:00.000Z',
		'2025-08-06T19:49:00.000Z',
		'2025-08-06T19:54:00.000Z',
		'2025-08-06T19:59:00.000Z',
		'2025-08-06T20:04:00.000Z',
		'2025-08-06T20:09:00.000Z',
		'2025-08-06T20:14:00.000Z',
		'2025-08-06T20:19:00.000Z',
		'2025-08-06T20:24:00.000Z',
		'2025-08-06T20:29:00.000Z',
		'2025-08-06T20:34:00.000Z',
		'2025-08-06T20:39:00.000Z',
		'2025-08-06T20:44:00.000Z',
		'2025-08-06T20:49:00.000Z',
		'2025-08-06T20:54:00.000Z',
		'2025-08-06T20:59:00.000Z',
		'2025-08-07T01:54:00.000Z',
		'2025-08-07T01:59:00.000Z',
		'2025-08-07T02:04:00.000Z',
		'2025-08-07T02:09:00.000Z',
		'2025-08-07T02:14:00.000Z',
		'2025-08-07T02:19:00.000Z',
		'2025-08-07T02:24:00.000Z',
		'2025-08-07T02:29:00.000Z',
		'2025-08-07T02:34:00.000Z',
		'2025-08-07T02:39:00.000Z',
		'2025-08-07T02:44:00.000Z',
		'2025-08-07T02:49:00.000Z',
		'2025-08-07T02:54:00.000Z',
		'2025-08-07T02:59:00.000Z',
		'2025-08-07T03:04:00.000Z',
		'2025-08-07T03:09:00.000Z',
		'2025-08-07T03:14:00.000Z',
		'2025-08-07T03:19:00.000Z',
		'2025-08-07T03:24:00.000Z',
		'2025-08-07T03:29:00.000Z',
		'2025-08-07T03:34:00.000Z',
		'2025-08-07T03:39:00.000Z',
		'2025-08-07T03:44:00.000Z',
		'2025-08-07T03:49:00.000Z',
		'2025-08-07T03:54:00.000Z',
		'2025-08-07T03:59:00.000Z',
		'2025-08-07T04:04:00.000Z',
		'2025-08-07T04:09:00.000Z',
		'2025-08-07T04:14:00.000Z',
		'2025-08-07T04:19:00.000Z',
		'2025-08-07T04:24:00.000Z',
		'2025-08-07T04:29:00.000Z',
		'2025-08-07T04:34:00.000Z',
		'2025-08-07T04:39:00.000Z',
		'2025-08-07T04:44:00.000Z',
		'2025-08-07T04:49:00.000Z',
		'2025-08-07T04:54:00.000Z',
		'2025-08-07T04:59:00.000Z',
		'2025-08-07T05:04:00.000Z',
		'2025-08-07T05:09:00.000Z',
		'2025-08-07T05:14:00.000Z',
		'2025-08-07T05:19:00.000Z',
		'2025-08-07T05:24:00.000Z',
		'2025-08-07T05:29:00.000Z',
		'2025-08-07T05:34:00.000Z',
		'2025-08-07T05:39:00.000Z',
		'2025-08-07T05:44:00.000Z',
		'2025-08-07T05:49:00.000Z',
		'2025-08-07T05:54:00.000Z',
		'2025-08-07T05:59:00.000Z',
		'2025-08-07T06:04:00.000Z',
		'2025-08-07T06:09:00.000Z',
		'2025-08-07T06:14:00.000Z',
		'2025-08-07T06:19:00.000Z',
		'2025-08-07T06:24:00.000Z',
		'2025-08-07T06:29:00.000Z',
		'2025-08-07T06:34:00.000Z',
		'2025-08-07T06:39:00.000Z',
		'2025-08-07T06:44:00.000Z',
		'2025-08-07T06:49:00.000Z',
		'2025-08-07T06:54:00.000Z',
		'2025-08-07T06:59:00.000Z',
		'2025-08-07T07:04:00.000Z',
		'2025-08-07T07:09:00.000Z',
		'2025-08-07T07:14:00.000Z',
		'2025-08-07T07:19:00.000Z',
		'2025-08-07T07:24:00.000Z',
		'2025-08-07T07:29:00.000Z',
		'2025-08-07T07:34:00.000Z',
		'2025-08-07T07:39:00.000Z',
		'2025-08-07T07:44:00.000Z',
		'2025-08-07T07:49:00.000Z',
		'2025-08-07T07:54:00.000Z',
		'2025-08-07T07:59:00.000Z',
		'2025-08-07T08:04:00.000Z',
		'2025-08-07T08:09:00.000Z',
		'2025-08-07T08:14:00.000Z',
		'2025-08-07T08:19:00.000Z',
		'2025-08-07T08:24:00.000Z',
		'2025-08-07T08:29:00.000Z',
		'2025-08-07T08:34:00.000Z',
		'2025-08-07T08:39:00.000Z',
		'2025-08-07T08:44:00.000Z',
		'2025-08-07T08:49:00.000Z',
		'2025-08-07T08:54:00.000Z',
		'2025-08-07T08:59:00.000Z',
		'2025-08-07T09:04:00.000Z',
		'2025-08-07T09:09:00.000Z',
		'2025-08-07T09:14:00.000Z',
		'2025-08-07T09:19:00.000Z',
		'2025-08-07T09:24:00.000Z',
		'2025-08-07T09:29:00.000Z',
		'2025-08-07T09:34:00.000Z',
		'2025-08-07T09:39:00.000Z',
		'2025-08-07T09:44:00.000Z',
		'2025-08-07T09:49:00.000Z',
		'2025-08-07T09:54:00.000Z',
		'2025-08-07T09:59:00.000Z',
		'2025-08-07T10:04:00.000Z',
		'2025-08-07T10:09:00.000Z',
		'2025-08-07T10:14:00.000Z',
		'2025-08-07T10:19:00.000Z',
		'2025-08-07T10:24:00.000Z',
		'2025-08-07T10:29:00.000Z',
		'2025-08-07T10:34:00.000Z',
		'2025-08-07T10:39:00.000Z',
		'2025-08-07T10:44:00.000Z',
		'2025-08-07T10:49:00.000Z',
		'2025-08-07T10:54:00.000Z',
		'2025-08-07T10:59:00.000Z',
		'2025-08-07T11:04:00.000Z',
		'2025-08-07T11:09:00.000Z',
		'2025-08-07T11:14:00.000Z',
		'2025-08-07T11:19:00.000Z',
		'2025-08-07T11:24:00.000Z',
		'2025-08-07T11:29:00.000Z',
		'2025-08-07T11:34:00.000Z',
		'2025-08-07T11:39:00.000Z',
		'2025-08-07T11:44:00.000Z',
		'2025-08-07T11:49:00.000Z',
		'2025-08-07T11:54:00.000Z',
		'2025-08-07T11:59:00.000Z',
		'2025-08-07T12:04:00.000Z',
		'2025-08-07T12:09:00.000Z',
		'2025-08-07T12:14:00.000Z',
		'2025-08-07T12:19:00.000Z'
	],
	startFixed: true,
	capacities: {
		wheelchairs: 0,
		bikes: 0,
		passengers: 1,
		luggage: 0
	}
};

async function main() {
	const p: WhitelistRequest = {
		...params,
		startBusStops: params.startBusStops.map((b) => {
			return { ...b, times: b.times.map((t) => new Date(t).getTime()) };
		}),
		targetBusStops: params.targetBusStops.map((b) => {
			return { ...b, times: b.times.map((t) => new Date(t).getTime()) };
		}),
		directTimes: params.directTimes.map((t) => new Date(t).getTime())
	};
	let direct: (Insertion | undefined)[] = [];
	if (p.directTimes.length != 0) {
		if (p.startFixed) {
			p.targetBusStops.push({
				...p.start,
				times: p.directTimes
			});
		} else {
			p.startBusStops.push({
				...p.target,
				times: p.directTimes
			});
		}
	}
	let [start, target] = await Promise.all([
		whitelist(p.start, p.startBusStops, p.capacities, false),
		whitelist(p.target, p.targetBusStops, p.capacities, true)
	]);

	if (p.directTimes.length != 0) {
		direct = p.startFixed ? target[target.length - 1] : start[start.length - 1];
		if (p.startFixed) {
			target = target.slice(0, target.length - 1);
		} else {
			start = start.slice(0, start.length - 1);
		}
	}

	console.assert(
		direct.length === p.directTimes.length,
		'Array size mismatch in Whitelist - direct.'
	);

	const response = {
		start,
		target,
		direct
	};
	console.log(JSON.stringify(response, null, 2));
}

main().catch((err) => {
	console.error('Error during booking:', err);
	process.exit(1);
});
